# 1. Primeros pasos
## 1.1 Cargamos librerías y dataset
```{r}
setwd("C:/Users/Javs/Downloads/Clase/3/3.2/BusquedaYAnalisisDeLaInformacion/Final")
load("enron_data_revised.rda")
library(igraph)
library(gplots)
```

## 1.2 Antes de empezar, hemos de entender las características del dataset
Enron fue una empresa energética estadounidense que, a principios de los 2001, quebró inesperadamente tras hacerse público un escándalo relacionado con prácticas irregulares de contabilidad. Al cabo de un tiempo, se publicaron en forma de dataset una lista de emails que probaban estas malas prácticas y es ese el dataset sobre el que vamos a trabajar.

Este dataset contiene vértices; que representan empleados de enron, y aristas; que representan emails enviados entre los diferentes empleados.

## 1.3 Veamos primero las dimensiones de los datos
```{r}
print("El número de aristas en el dataset:")
nrow(edges.full)
print("La descripción del objeto 'aristas':")
str(edges.full)
print("El número de nodos en el dataset:")
nrow(nodes)
print("La descripción del objeto 'aristas':")
str(nodes)
```


# 2. Grafos
## 2.1 Creado y propiedades del grafo
El siguiente paso será generar un grafo a partir del dataset de Enron.

Para ello, concatenaremos en un objeto nuevo los parámetros que queramos en el grafo. En este caso 'emisor', 'receptor', 'tipo', 'fecha' y 'sujeto'. Es importante destacar que queremos un grafo dirigido, ya que los emails tienen emisor y destinatario. El último parámetro le indica a la función que los vértices del grafo tiene que sacarlos del objeto 'nodos'.

```{r}
network.full <- graph.data.frame(edges.full[,c("sender",
                                               "receiver",
                                               "type",
                                               "date",
                                               "subject")],
                                              directed = TRUE,
                                              vertices = nodes)

class(network.full)
summary(network.full)
```

Con igraph podemos acceder a los nodos con la keyword V (vertice) y a las aristas con E (edge).

Las siguientes líneas nos muestran los diez primeros vértices (empleados de enron) y las dies primeras aristas (mails intercambiados entre empleados).

```{r}
V(network.full)[1:10]
E(network.full)[1:10]
```

También podemos introducir estas keywords en una tabla como parámetros. En el ejemplo de abajo estamos pasando todos los "status" (posición en la empresa) posibles a una tabla, lo que nos muestra el total de nodos (empleados) que tiene cada "status".

```{r}
table(V(network.full)$status)
```

## 2.2 Visualización del grafo
Los grafos son una herramienta muy útil para entender las propiedades de las relaciones de un conjunto de datos. Nos pueden mostrar cantidades enormes de información que, de otro modo, sería mucho más difícil encontrar.

Uno de las mejores ventajas de los grafos es su propiedad visual; relacionar vértices con aristas es muy intuitivo, sencillo y eficaz, lo que facilita enormemente construir observaciones complejas sobre las interacciones simples del conjunto de datos.

La desventaja que tienen los grafos es que el ojo humano no puede entender la complejidad del enramado de un grafo mirando una tabla de relaciones; para nosotros es mucho más rápido entender un grafo mediante un esquema o dibujo. Por eso mismo y porque R no puede correrlo nativamente, utilizaremos una herramienta externa llamada Gephi, que nos ayudará a visualizar los mails de Enron una vez tengamos un grafo que podamos introducirle.

Para exportar nuestro grafo enronense a un lenguaje que Gephi entienda, utilizaremos el siguiente código:

```{r}

write.graph(network.full,
            file = "enron_graph_1.graphml",
            format = "graphml")
```

El código superior muestra claramente como transformamos nuestro grafo creado en el punto 2.1 (network) en un archivo de extensión "graphml". La extensión "graphml" está conmstruida sobre XML y permite describir las propiedades estructurales de casi cualquier grafo.

Una vez tenemos nuestro archivo "graphml", lo introduciremos en Gephi.

En Gephi, podemos trabajar directamente con las propiedades visuales del grafo, nada más introducirlo, se verá así:

![GraphFirst](.\Grafos\First.jpg)

Con el objetivo de hacer más comprensible el grafo, organizaremos los nodos y aristas con colores en base a el número de conexiones entrantes y salientes; es decir, los empleados que más emails enviaron se verán de un color (en nuestro caso naranja) y lo que menos de otro (morado), estando el resto de empleados en un gradiente entre esos colores.

![GraphFirstColor](.\Grafos\FirstColor.jpg)

Otra ayuda visual es la disposición del grafo, como vemos es extremadamente caótico y, aunque los colores ayudan, es completamente ilegible. Para ello, lo estructuraremos mediante una disposición predeterminada:

![GraphFirstColorDisp](.\Grafos\FirstColorDisp.jpg)

Por último, en la pestaña de previsualización, le daremos los úlitmos retoques de formato para que sea fácil de comprender entero de un vistazo. Para conseguir esto haremos muchos cambios estéticos, desde el tamaño de las aristas hasta el texto que muestran las etiquetas. El resultafo final es el siguiente:

![GraphEnron](.\Grafos\GrafoEnron.png)

El grafo es muy denso, veamos una versión simplificada.

![GraphEnron](.\Grafos\GrafoEnronStripped.jpg)

Este grafo es mucho más claro y visual ya que tenemos una muestra mucho más pequeña; aún así podemos sacar mucha información útil de estga muestra.

Vemos que los nodos en el centro tienen mucho más tráfico que los periféricos, lo que nos da a entender que son personas importantes dentro de la empresa. Otro detalle a destacar es que los nodos periféricos apenas tienen comunicaciones entre sí, tienen muchas más comunicaciones dirigidas al centro, donde quizá estén sus superiores. Adjunto una imagen que nos permite ver mejor el centro, en el que confirmamos que están los jefes de Enron.

![GraphEnron](.\Grafos\GrafoEnronStrippedZoom.jpg)

## 2.3 Operaciones sobre el grafo
Los grafos nos permiten hacer muchas cosas más allá de ayudarnos a visualizar un puñado de datos; también es posible realizar operaciones sobre ellos para obtener propiedades y relaciones de los datos enronenses.

Los grafos tienen muchas propiedades, entre ellas veremos las siguientes aplicadas a nuestro grafo: la transitividad, el diámetro, la reciprocidad, la densidad, y el censo de triadas. Antes de explicarlas individualmente, es importante entender la función en la que basan todas sus operaciones: "get shortest path" (búsqueda del camino más corto entre dos nodos).

La función del camino más corto nos mostrará el recorrido de aristas más corto entre los nodos que le marquemos como input. En el caso de abajo, buscaremos el camino más corto entre un empleado con el mail "kevin.m.presto@enron.com" y otro con el apellido "Barbo":

```{r}
shortestExample = get.shortest.paths(from = V(network.full)$name == "kevin.m.presto@enron.com",
                   to = V(network.full)$lastName == "Barbo",
                   graph = network.full)
nodes[c(shortestExample[["vpath"]][[1]]),]
```

Podemos observar como el camino más corto entre el vicepresidente Presto y el comerciante Barbo es de dos saltos, siendo el nodo intermedio el vicepresidente Hayslet; esto quiere decir que Barbo y Presto no han tenido comunicación oficial directa.

### 2.3.1 Transitividad
La transitividad en un grafo es la probabilidad de que la red tenga nodos adyacentes interconectados, es decir, la existencia de subcomunidades o clústeres cuyos miembros están altamente relacionados.

Un ejemplo de grafo con una transitividad alta es el inferior, en el que vemos claramente dos clústeres de grupos diferentes.

![GraphEnron](.\Grafos\GrafoEjemplo.jpg)

Para evular la transitividad de un grafo, utilizaremos la función "transitivity". Esta función tiene un parámetro llamado "type", el cual especifica entre un análisis local o global de los nodos.

Con el siguiente código analizamos ambos tipos y extraemos un histograma de la transitividad local:

```{r}
transitivity(network.full, type="global")
transitivity(network.full, type="local")
hist(transitivity(network.full, type="local"))
```

La transitividad global nos da 0.4212257, lo que quiere decir que hay un número moderado de clústeres en el dataset.



### 2.3.2 Diámetro
El diámetro del grafo es su longitud: el camino más largo del grafo; es decir, el mayor número de vértices que se han de atravesar para llegar desde un nodo hasta otro (con las condiciones de que no puedes recorrer dos veces el mismo nodo y no puedess volver sobre tus pasos).

El diámetro del grafo inferior vemos que es de 10 nodos, puesto que podemos ir desde Hold hasta Tom atravesando todos los nodos.

![GraphEnron](.\Grafos\GrafoEjemplo.jpg)

Para ver estas propiedades en nuestro dataset enronense, utilizaremos el siguiente código:

```{r}
diameter(network.full)
```

Para ver cuáles son estos nodos tan separados utilizaremos "farthest.nodes" y meteremos su output en "nodes" para que sea más legible:

```{r}
nodes[c(farthest.nodes(network.full)[["vertices"]]),]
```

### 2.3.3 Reciprocidad
La reprocidad de un grafo es la probabilidad de que nodos en un conjunto dirigido estén conectados directamente. Esta medida nos permite ver como de interconectado está el grafo entre sí.

En este grafo, el índice de reciprocidad es muy bajo, ya que los nodos están muy poco conectados entre sí.

![GraphEnron](.\Grafos\GrafoEjemplo.jpg)

Por otro lado, el índice de reciprocidad en este otro ejemplo es altísimo, ya que los nodos están muy conectados entre sí.

![GraphEnron](.\Grafos\GrafoEjemploReciprocidad.jpg)

Para ver el índice de reciprocidad del dataset de Enron, utilizaremos la función "reciprocity". Nos da un resultado de 0.421992, lo que indica que en el grafo hay muchas conexiones pero no está completamente conectado entre sí.

```{r}
reciprocity(network.full)
```

### 2.3.4 Densidad
La densidad de un grafo hace referencia a la relación entre el número de aristas de un grafo y el número máximo que podría tener el mismo grafo.

![GraphEnron](.\Grafos\GrafoEjemploReciprocidad.jpg)

Si observamos el ejemplo anterior, podemos ver que se trata de un grafo muy denso. Si nos fijamos en el siguiente, vemos que se trata de un grafo muy poco denso, ya que hay pocas aristas en relación a las que podría haber.

![GraphEnron](.\Grafos\GrafoEjemplo.jpg)

Para averiguar la densidad del grafo de enron, haremos uso de "edge_density":

```{r}
edge_density(network.full)

```

### 2.3.5 Censo de triadas
























